<script setup lang="ts">
import { ref, onMounted, computed, watch } from 'vue'
import { useRoute } from 'vue-router'
import PageRenderer from './PageRenderer.vue'
import ChangesViewer from '@/components/ui/ChangesViewer.vue'
import type { TreeBlock } from '@/types/block'
import { env, devLog, devError } from '@/utils/env'

const route = useRoute()

const loading = ref(true)
const error = ref<string | null>(null)
const loadedData = ref<TreeBlock[] | null>(null)
const lastAction = ref<any>(null)
const isMockData = ref<boolean>(false)
const apiError = ref<string | null>(null)

// Debug –ø–∞–Ω–µ–ª—å
const showDebug = ref(false)

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è iframe
const isIframeOpen = ref(false)

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
const isFullscreen = ref(false)

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º debug –≤ dev —Ä–µ–∂–∏–º–µ
const isDev = computed(() => env.devMode)

const configPath = computed(() => {
  // –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É –∏–∑ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã—Ö —Ä–æ—É—Ç–∞
  return route.meta.configPath as string || ''
})

// –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –ø—É—Ç–∏ –∏–ª–∏ –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ä–æ—É—Ç–∞
const projectId = computed(() => {
  return route.meta.projectId as string || route.params.projectId as string || ''
})

const currentState = computed(() => {
  if (loading.value) return '–ó–∞–≥—Ä—É–∑–∫–∞'
  if (error.value) return '–û—à–∏–±–∫–∞'
  return '–ó–∞–≥—Ä—É–∂–µ–Ω–æ'
})

const dataMode = computed(() => {
  if (loading.value) return '–ó–∞–≥—Ä—É–∑–∫–∞...'
  if (error.value) return '–û—à–∏–±–∫–∞'
  return isMockData.value ? 'Mock –¥–∞–Ω–Ω—ã–µ' : '–†–µ–∞–ª—å–Ω—ã–π API'
})

const treeInfo = computed(() => {
  if (!loadedData.value) return null
  
  function getMaxDepth(blocks: TreeBlock[], currentDepth = 0): number {
    let maxDepth = currentDepth
    for (const block of blocks) {
      if (block.children && block.children.length > 0) {
        maxDepth = Math.max(maxDepth, getMaxDepth(block.children, currentDepth + 1))
      }
    }
    return maxDepth
  }
  
  function countBlocks(blocks: TreeBlock[]): number {
    let count = blocks.length
    for (const block of blocks) {
      if (block.children) {
        count += countBlocks(block.children)
      }
    }
    return count
  }
  
  const maxDepth = getMaxDepth(loadedData.value)
  const totalBlocks = countBlocks(loadedData.value)
  
  return {
    maxDepth,
    totalBlocks,
    rootBlocks: loadedData.value.length
  }
})

function onDataLoaded(result: { data: TreeBlock[], isMockData: boolean, error?: string }) {
  devLog('üìä –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ RoutePage:', result)
  loadedData.value = result.data
  isMockData.value = result.isMockData
  apiError.value = result.error || null
  loading.value = false
  error.value = null
}

function onDataError(errorMessage: string) {
  devError('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ RoutePage:', errorMessage)
  error.value = errorMessage
  loading.value = false
}

function handleAction(actionData: any) {
  devLog('üéØ Action received in RoutePage:', actionData)
  lastAction.value = {
    timestamp: new Date().toISOString(),
    ...actionData
  }
  // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
}

function retry() {
  devLog('üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏')
  loading.value = true
  error.value = null
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è route.path
watch(() => route.path, (newPath, oldPath) => {
  if (newPath !== oldPath) {
    devLog(`üîÑ –ú–∞—Ä—à—Ä—É—Ç –∏–∑–º–µ–Ω–∏–ª—Å—è —Å ${oldPath} –Ω–∞ ${newPath}. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ...`)
    loading.value = true
    error.value = null
    loadedData.value = null
    lastAction.value = null
    isMockData.value = false
    apiError.value = null
  }
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
function onChangesSaved(result: any) {
  lastAction.value = {
    type: 'changes-saved',
    timestamp: Date.now(),
    source_component: 'ChangesTracker',
    source_mode: 'save',
    details: result
  }
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ debug –ø–∞–Ω–µ–ª–∏
  if (isDev.value && showDebug.value) {
    devLog('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', result)
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è iframe
function toggleIframe() {
  isIframeOpen.value = !isIframeOpen.value
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ iframe –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
function closeIframe() {
  isIframeOpen.value = false
  isFullscreen.value = false
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
function toggleFullscreen() {
  isFullscreen.value = !isFullscreen.value
}

onMounted(() => {
  devLog('üöÄ RoutePage –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—É—Ç–∏:', route.path)
  devLog('üìÅ Config path:', configPath.value)
})
</script>

<template>
  <div class="route-page">
    <!-- Debug –∫–Ω–æ–ø–∫–∞ (—Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ) -->
    <button
      v-if="isDev && !showDebug"
      class="debug-toggle"
      @click="showDebug = !showDebug"
    >
      üëÅÔ∏è Debug Info
    </button>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è iframe -->
    <button
      @click="toggleIframe"
      class="iframe-toggle-button"
      :class="{ 'active': isIframeOpen }"
    >
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.99984 24L4.93317 27.0666C4.51095 27.4888 4.0274 27.5835 3.48251 27.3506C2.93762 27.1177 2.66562 26.7008 2.66651 26.1V5.33329C2.66651 4.59996 2.92784 3.9724 3.45051 3.45063C3.97317 2.92885 4.60073 2.66751 5.33317 2.66663H26.6665C27.3998 2.66663 28.0278 2.92796 28.5505 3.45063C29.0732 3.97329 29.3341 4.60085 29.3332 5.33329V21.3333C29.3332 22.0666 29.0723 22.6946 28.5505 23.2173C28.0287 23.74 27.4007 24.0008 26.6665 24H7.99984ZM9.33317 18.6666H17.3332C17.711 18.6666 18.0278 18.5386 18.2838 18.2826C18.5398 18.0266 18.6674 17.7102 18.6665 17.3333C18.6656 16.9564 18.5376 16.64 18.2825 16.384C18.0274 16.128 17.711 16 17.3332 16H9.33317C8.95539 16 8.63895 16.128 8.38384 16.384C8.12873 16.64 8.00073 16.9564 7.99984 17.3333C7.99895 17.7102 8.12695 18.0271 8.38384 18.284C8.64073 18.5408 8.95717 18.6684 9.33317 18.6666ZM9.33317 14.6666H22.6665C23.0443 14.6666 23.3612 14.5386 23.6172 14.2826C23.8732 14.0266 24.0007 13.7102 23.9998 13.3333C23.999 12.9564 23.871 12.64 23.6158 12.384C23.3607 12.128 23.0443 12 22.6665 12H9.33317C8.95539 12 8.63895 12.128 8.38384 12.384C8.12873 12.64 8.00073 12.9564 7.99984 13.3333C7.99895 13.7102 8.12695 14.0271 8.38384 14.284C8.64073 14.5408 8.95717 14.6684 9.33317 14.6666ZM9.33317 10.6666H22.6665C23.0443 10.6666 23.3612 10.5386 23.6172 10.2826C23.8732 10.0266 24.0007 9.71018 23.9998 9.33329C23.999 8.9564 23.871 8.63996 23.6158 8.38396C23.3607 8.12796 23.0443 7.99996 22.6665 7.99996H9.33317C8.95539 7.99996 8.63895 8.12796 8.38384 8.38396C8.12873 8.63996 8.00073 8.9564 7.99984 9.33329C7.99895 9.71018 8.12695 10.0271 8.38384 10.284C8.64073 10.5408 8.95717 10.6684 9.33317 10.6666Z" fill="white"/>
      </svg>
    </button>

    <!-- Debug –ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ –≤ dev —Ä–µ–∂–∏–º–µ) -->
    <div 
      v-if="isDev && showDebug" 
      class="debug-panel"
      @click.self="showDebug = false"
    >
      <div class="debug-content" @click.stop>
        <div class="debug-header">
          <h3>üîß Debug Info</h3>
          <button @click="showDebug = false" class="debug-close">√ó</button>
        </div>

        <div class="debug-sections">
          <div class="debug-section">
            <h4>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
            <div class="debug-info">
              <p><strong>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</strong> {{ currentState }}</p>
              <p><strong>–ü—É—Ç—å:</strong> {{ route.path }}</p>
              <p><strong>–ö–æ–Ω—Ñ–∏–≥ –ø—É—Ç—å:</strong> {{ route.meta.configPath }}</p>
              <p><strong>Raw –±–ª–æ–∫–æ–≤:</strong> {{ loadedData?.length || 0 }}</p>
              <div v-if="treeInfo" class="tree-structure">
                <p><strong>üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ—Ä–µ–≤–∞:</strong></p>
                <ul class="tree-stats">
                  <li>üå≥ –ö–æ—Ä–Ω–µ–≤—ã—Ö –±–ª–æ–∫–æ–≤: {{ treeInfo.rootBlocks }}</li>
                  <li>üì¶ –í—Å–µ–≥–æ –±–ª–æ–∫–æ–≤: {{ treeInfo.totalBlocks }}</li>
                  <li>üìè –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞: {{ treeInfo.maxDepth }}</li>
                </ul>
              </div>
              <div class="w-full">
                <div
                  v-if="!loading && loadedData?.length"
                  :class="isMockData ? 'mock-indicator' : 'api-indicator'"
                >
                  <strong>üåê –†–µ–∂–∏–º:</strong> {{ dataMode }}
                </div>
              </div>

              <div v-if="apiError" class="error-info">
                <strong>‚ö†Ô∏è –û—à–∏–±–∫–∞ API:</strong> {{ apiError }}
              </div>
            </div>
          </div>

          <div v-if="loadedData?.length" class="debug-section">
            <details class="debug-details">
              <summary>–ü–æ–∫–∞–∑–∞—Ç—å raw –∫–æ–Ω—Ñ–∏–≥</summary>
              <pre>{{ JSON.stringify(loadedData, null, 2) }}</pre>
            </details>
          </div>

          <div v-if="lastAction" class="debug-section">
            <h4>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ:</h4>
            <div class="action-info">
              <p><strong>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:</strong> {{ lastAction.source_component || '–ù–µ —É–∫–∞–∑–∞–Ω' }}</p>
              <p><strong>–†–µ–∂–∏–º:</strong> {{ lastAction.source_mode || '–ù–µ —É–∫–∞–∑–∞–Ω' }}</p>
              <p v-if="lastAction.nesting_level !== undefined">
                <strong>–£—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏:</strong> {{ lastAction.nesting_level }}
              </p>
              <p><strong>–í—Ä–µ–º—è:</strong> {{ new Date(lastAction.timestamp).toLocaleTimeString() }}</p>
              <details class="debug-details">
                <summary>–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è</summary>
                <pre>{{ JSON.stringify(lastAction, null, 2) }}</pre>
              </details>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å iframe -->
    <Transition name="iframe-modal">
      <div v-if="isIframeOpen" class="iframe-modal-overlay" @click="closeIframe">
        <div class="iframe-modal" @click.stop :class="{ 'fullscreen': isFullscreen }">
          <div class="iframe-header">
            <h3 class="iframe-title">–ß–∞—Ç-–±–æ—Ç</h3>
            <div class="iframe-controls">
              <button @click="toggleFullscreen" class="iframe-fullscreen-button" :title="isFullscreen ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω'">
                <svg v-if="!isFullscreen" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 3H7V5H5V7H3V3ZM17 3V7H15V5H13V3H17ZM17 17H13V15H15V13H17V17ZM7 17V15H5V13H3V17H7Z" fill="currentColor"/>
                </svg>
                <svg v-else width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5 5H9V7H7V9H5V5ZM15 5V9H13V7H11V5H15ZM15 15H11V13H13V11H15V15ZM9 15V13H7V11H5V15H9Z" fill="currentColor"/>
                </svg>
              </button>
              <button @click="closeIframe" class="iframe-close-button">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
          <iframe 
            src="http://localhost:5179/chat?hideMenuIcon=true"
            width="508"
            height="552"
            frameborder="0"
            class="iframe-content"
            title="–ß–∞—Ç-–±–æ—Ç"
          ></iframe>
        </div>
      </div>
    </Transition>

    <div v-if="loading" class="loading-state">
      <div class="loading-card">
        <div class="loading-icon">‚ö°</div>
        <h2 class="loading-title">–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...</h2>
        <p class="loading-text">–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</p>
      </div>
      <PageRenderer 
        :config-file="configPath"
        :skeleton="true"
        :project-id="projectId"
        @loaded="onDataLoaded"
        @error="onDataError"
        @action="handleAction"
      />
    </div>
    
    <div v-else-if="error" class="error-state">
      <div class="error-card">
        <div class="error-icon">‚ùå</div>
        <h2 class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
        <p class="error-message">{{ error }}</p>
        <button @click="retry" class="retry-button">
          üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        </button>
      </div>
    </div>
    
    <div v-else class="content-state">
      <PageRenderer 
        :config-file="configPath"
        :skeleton="false"
        :project-id="projectId"
        @loaded="onDataLoaded"
        @error="onDataError"
        @action="handleAction"
        @changes-saved="onChangesSaved"
      />
    </div>
    
    <!-- –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <ChangesViewer />
  </div>
</template>

<style scoped>
.route-page {
  @apply relative z-20;
  min-height: calc(100vh - 100px);
}

/* Debug –∫–Ω–æ–ø–∫–∞ */
.debug-toggle {
  @apply fixed bottom-4 right-4 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl shadow-xl;
  @apply hover:from-blue-600 hover:to-indigo-600 transform hover:scale-105 transition-all duration-300;
  @apply focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-opacity-50;
  z-index: 1000;
  padding: 12px 16px;
  font-weight: 600;
  font-size: 14px;
}

/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è iframe */
.iframe-toggle-button {
  @apply fixed bottom-20 right-4 w-14 h-14 text-white rounded-full shadow-lg transition-all duration-200 flex items-center justify-center;
  background-color: #33AFE1; /* –ì–æ–ª—É–±–æ–π —Ü–≤–µ—Ç */
  z-index: 1000;
}

.iframe-toggle-button:hover {
  background-color: #2A9BC7; /* –ù–µ–º–Ω–æ–≥–æ —Ç–µ–º–Ω–µ–µ –¥–ª—è hover */
}

.iframe-toggle-button:focus {
  @apply outline-none ring-2 ring-offset-2;
  ring-color: #33AFE1;
}

.iframe-toggle-button.active {
  @apply bg-gray-500;
}

.iframe-toggle-button.active:hover {
  @apply bg-gray-600;
}

.iframe-toggle-button:hover {
  @apply transform scale-105;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å iframe */
.iframe-modal-overlay {
  @apply fixed inset-0 bg-black bg-opacity-50 flex items-end justify-end;
  z-index: 1001;
  padding: 20px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—ë–≤ —ç–∫—Ä–∞–Ω–∞ */
}

.iframe-modal {
  @apply bg-white rounded-lg shadow-2xl overflow-hidden transition-all duration-300;
  width: 528px; /* 508px + padding */
  height: 592px; /* 552px + header */
  margin-top: 80px; /* –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ */
  transform-origin: bottom right; /* –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –Ω–∏–∂–Ω–µ–≥–æ —É–≥–ª–∞ */
}

.iframe-modal.fullscreen {
  @apply inset-4 z-[1000];
  width: calc(100vw - 32px);
  height: calc(100vh - 32px);
  margin: 0;
  border-radius: 12px;
  transform-origin: bottom right; /* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–∫—É —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
}

.iframe-header {
  @apply flex items-center justify-between px-4 py-3 bg-gray-50 border-b border-gray-200;
}

.iframe-title {
  @apply font-semibold text-gray-800 m-0;
  font-size: 18px;
  font-family: 'Golos Text', system-ui, -apple-system, sans-serif;
}

.iframe-controls {
  @apply flex items-center gap-2;
}

.iframe-fullscreen-button {
  @apply text-gray-500 hover:text-gray-700 transition-colors p-1 rounded;
}

.iframe-fullscreen-button:focus {
  @apply outline-none ring-2 ring-blue-300;
}

.iframe-close-button {
  @apply text-gray-500 hover:text-gray-700 transition-colors p-1 rounded;
}

.iframe-close-button:focus {
  @apply outline-none ring-2 ring-blue-300;
}

.iframe-content {
  @apply w-full border-0;
  height: 552px;
}

.iframe-modal.fullscreen .iframe-content {
  height: calc(100% - 60px); /* –í—ã—á–∏—Ç–∞–µ–º –≤—ã—Å–æ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.iframe-modal-enter-active,
.iframe-modal-leave-active {
  @apply transition-all duration-300;
}

.iframe-modal-enter-from,
.iframe-modal-leave-to {
  @apply opacity-0;
}

.iframe-modal-enter-from .iframe-modal,
.iframe-modal-leave-to .iframe-modal {
  @apply transform scale-95;
}

.iframe-modal-enter-to,
.iframe-modal-leave-from {
  @apply opacity-100;
}

.iframe-modal-enter-to .iframe-modal,
.iframe-modal-leave-from .iframe-modal {
  @apply transform scale-100;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
@media (max-width: 640px) {
  .iframe-modal-overlay {
    @apply items-center justify-center;
    padding: 16px;
  }
  
  .iframe-modal {
    @apply mx-0;
    width: calc(100vw - 32px);
    max-width: 528px;
    height: 80vh;
    max-height: 592px;
    margin-bottom: 0;
  }
  
  .iframe-content {
    height: calc(80vh - 60px);
    max-height: 552px;
  }
  
  .iframe-toggle-button {
    @apply bottom-24 right-4;
  }
}

/* Debug –ø–∞–Ω–µ–ª—å - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.debug-panel {
  @apply pb-4 fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center;
  z-index: 1001;
}

.debug-content {
  @apply bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden;
  @apply border border-gray-200;
}

.debug-header {
  @apply flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200;
}

.debug-header h3 {
  @apply text-lg font-semibold text-blue-600;
}

.debug-close {
  @apply text-gray-500 hover:text-gray-700 text-2xl w-8 h-8 flex items-center justify-center rounded;
  @apply hover:bg-gray-200 transition-colors;
}

.debug-sections {
  @apply p-4 overflow-auto max-h-[calc(90vh-80px)];
}

.debug-section {
  @apply mb-6 last:mb-0;
}

.debug-section h4 {
  @apply font-semibold text-sm text-gray-700 mb-2;
}

.debug-info {
  @apply space-y-1 text-sm;
}

.debug-info p {
  @apply text-gray-600;
}

.debug-info strong {
  @apply text-gray-800;
}

.debug-details {
  @apply border border-gray-200 rounded;
}

.debug-details summary {
  @apply cursor-pointer p-3 bg-gray-50 hover:bg-gray-100 transition-colors;
  @apply font-medium text-gray-700;
}

.debug-details pre {
  @apply p-4 bg-gray-900 text-gray-100 text-xs overflow-auto;
  @apply border-t border-gray-200;
  font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ä–µ–∂–∏–º–∞ */
.api-indicator {
  @apply text-green-700 bg-green-100 px-2 py-1 rounded inline-block;
}

.mock-indicator {
  @apply text-yellow-700 bg-yellow-100 px-2 py-1 rounded inline-block;
}

.error-info {
  @apply text-red-700 bg-red-100 px-2 py-1 rounded inline-block;
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ */
.loading-state {
  @apply space-y-8;
}

.loading-card {
  @apply text-center p-8 bg-white rounded-2xl shadow-xl border border-blue-100;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
}

.loading-icon {
  @apply text-6xl mb-4;
  animation: bounce 1s ease-in-out infinite;
}

.loading-title {
  @apply text-2xl font-bold text-gray-800 mb-2;
}

.loading-text {
  @apply text-gray-600;
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—à–∏–±–∫–∏ */
.error-state {
  @apply flex items-center justify-center min-h-[60vh];
}

.error-card {
  @apply text-center p-8 bg-white rounded-2xl shadow-xl border border-red-100 max-w-md;
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(220, 38, 38, 0.05) 100%);
}

.error-icon {
  @apply text-6xl mb-4;
}

.error-title {
  @apply text-2xl font-bold text-red-800 mb-4;
}

.error-message {
  @apply text-red-600 mb-6 leading-relaxed;
}

.retry-button {
  @apply px-6 py-3 bg-red-600 text-white rounded-lg font-medium;
  @apply hover:bg-red-700 transition-all duration-300;
  @apply transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2;
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
.content-state {
  @apply animate-fadeIn;
}

.action-info {
  @apply space-y-1 text-sm;
}

.action-info p {
  @apply text-gray-600;
}

.action-info strong {
  @apply text-gray-800;
}

.tree-structure {
  @apply my-2 p-2 bg-blue-50 rounded border border-blue-200;
}

.tree-stats {
  @apply mt-1 ml-4 space-y-1 text-xs;
}

.tree-stats li {
  @apply text-gray-600;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fadeIn {
  animation: fadeIn 0.6s ease-out;
}
</style> 