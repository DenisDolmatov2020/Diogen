<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–∫—Å–∏ - Diogen Chat Widget</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-case {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .test-case h3 {
            margin-top: 0;
            color: #333;
        }
        .result {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 8px;
            margin-top: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        .error {
            background: #ffeaea;
            border-color: #f44336;
        }
        button {
            background: #33AFE1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
        }
        button:hover {
            background: #2A9BC7;
        }
        .info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 12px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏</h1>
    
    <div class="info">
        <strong>–¢–µ–∫—É—â–∞—è —Å—Ä–µ–¥–∞:</strong><br>
        <span id="current-env"></span>
    </div>

    <div class="test-case">
        <h3>–¢–µ—Å—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (devMode: auto)</h3>
        <p>API: https://knowledge.slovo-soft.ru/api/v1/mentorium</p>
        <button onclick="testProxyLogic('auto', 'https://knowledge.slovo-soft.ru/api/v1/mentorium')">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <div id="test1-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-case">
        <h3>–¢–µ—Å—Ç 2: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ (devMode: true)</h3>
        <p>API: https://knowledge.slovo-soft.ru/api/v1/mentorium</p>
        <button onclick="testProxyLogic('true', 'https://knowledge.slovo-soft.ru/api/v1/mentorium')">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <div id="test2-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-case">
        <h3>–¢–µ—Å—Ç 3: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ (devMode: false)</h3>
        <p>API: https://knowledge.slovo-soft.ru/api/v1/mentorium</p>
        <button onclick="testProxyLogic('false', 'https://knowledge.slovo-soft.ru/api/v1/mentorium')">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <div id="test3-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-case">
        <h3>–¢–µ—Å—Ç 4: Same-origin API (–±–µ–∑ –ø—Ä–æ–∫—Å–∏)</h3>
        <p>API: /api/local-endpoint</p>
        <button onclick="testProxyLogic('auto', '/api/local-endpoint')">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <div id="test4-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-case">
        <h3>–¢–µ—Å—Ç 5: –î—Ä—É–≥–æ–π –≤–Ω–µ—à–Ω–∏–π API</h3>
        <p>API: https://api.example.com/chat</p>
        <button onclick="testProxyLogic('auto', 'https://api.example.com/chat')">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <div id="test5-result" class="result" style="display: none;"></div>
    </div>

    <script>
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π —Å—Ä–µ–¥–µ
        document.getElementById('current-env').innerHTML = `
            <strong>Origin:</strong> ${window.location.origin}<br>
            <strong>Hostname:</strong> ${window.location.hostname}<br>
            <strong>Port:</strong> ${window.location.port || 'default'}<br>
            <strong>Protocol:</strong> ${window.location.protocol}
        `;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–∫—Å–∏
        function testProxyLogic(devMode, apiUrl) {
            try {
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
                const config = {
                    devMode: devMode,
                    apiUrl: apiUrl
                };

                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ª–æ–≥–∏–∫—É –∏–∑ –≤–∏–¥–∂–µ—Ç–∞
                const result = shouldUseProxy(config);
                
                const testNumber = getTestNumber(devMode, apiUrl);
                const resultDiv = document.getElementById(`test${testNumber}-result`);
                
                resultDiv.style.display = 'block';
                resultDiv.className = 'result';
                resultDiv.innerHTML = `
                    <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${result.shouldUse ? '‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏' : '‚ùå –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ'}<br>
                    <strong>URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞:</strong> ${result.shouldUse ? '/api/proxy' : apiUrl}<br>
                    <strong>–î–µ—Ç–∞–ª–∏:</strong><br>
                    ‚Ä¢ devMode: ${devMode}<br>
                    ‚Ä¢ currentOrigin: ${result.currentOrigin}<br>
                    ‚Ä¢ apiOrigin: ${result.apiOrigin}<br>
                    ‚Ä¢ isDifferentOrigin: ${result.isDifferentOrigin}<br>
                    ‚Ä¢ isLocalhost: ${result.isLocalhost}<br>
                    ‚Ä¢ isProduction: ${result.isProduction}<br>
                    ‚Ä¢ shouldUse: ${result.shouldUse}
                `;
            } catch (error) {
                const testNumber = getTestNumber(devMode, apiUrl);
                const resultDiv = document.getElementById(`test${testNumber}-result`);
                
                resultDiv.style.display = 'block';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `<strong>–û—à–∏–±–∫–∞:</strong> ${error.message}`;
            }
        }

        function getTestNumber(devMode, apiUrl) {
            if (devMode === 'auto' && apiUrl.includes('knowledge.slovo-soft.ru')) return 1;
            if (devMode === 'true') return 2;
            if (devMode === 'false') return 3;
            if (apiUrl.startsWith('/')) return 4;
            return 5;
        }

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ª–æ–≥–∏–∫—É shouldUseProxy –∏–∑ –≤–∏–¥–∂–µ—Ç–∞
        function shouldUseProxy(config) {
            // –ï—Å–ª–∏ devMode —è–≤–Ω–æ –∑–∞–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if (config.devMode === 'true' || config.devMode === true) {
                return {
                    shouldUse: true,
                    reason: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω',
                    currentOrigin: window.location.origin,
                    apiOrigin: 'N/A',
                    isDifferentOrigin: true,
                    isLocalhost: false,
                    isProduction: false
                };
            }
            if (config.devMode === 'false' || config.devMode === false) {
                return {
                    shouldUse: false,
                    reason: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω',
                    currentOrigin: window.location.origin,
                    apiOrigin: 'N/A',
                    isDifferentOrigin: false,
                    isLocalhost: false,
                    isProduction: false
                };
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (devMode === 'auto')
            const currentOrigin = window.location.origin;
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ URL
            let apiOrigin;
            let isDifferentOrigin;
            
            if (config.apiUrl.startsWith('/')) {
                // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π URL - same origin
                apiOrigin = currentOrigin;
                isDifferentOrigin = false;
            } else {
                // –ê–±—Å–æ–ª—é—Ç–Ω—ã–π URL
                try {
                    const apiUrl = new URL(config.apiUrl);
                    apiOrigin = apiUrl.origin;
                    isDifferentOrigin = apiOrigin !== currentOrigin;
                } catch (error) {
                    // –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL
                    apiOrigin = 'Invalid URL';
                    isDifferentOrigin = false;
                }
            }
            
            // –í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (localhost) –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' ||
                               window.location.hostname.includes('localhost');
            
            const isDevPort = window.location.port === '5173' || 
                             window.location.port === '3000' ||
                             window.location.port === '8080';
            
            // –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API
            const isProduction = !isLocalhost;
            
            const shouldUse = isDifferentOrigin && (isProduction || (isLocalhost && isDevPort));
            
            return {
                shouldUse,
                currentOrigin,
                apiOrigin,
                isDifferentOrigin,
                isLocalhost,
                isDevPort,
                isProduction
            };
        }
    </script>
</body>
</html> 