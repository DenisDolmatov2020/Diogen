<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏ - Diogen Chat Widget</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #ffd700;
        }
        
        .test-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.5);
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.3);
            border: 1px solid rgba(33, 150, 243, 0.5);
        }
        
        code {
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .console-log {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏</h1>
        
        <div class="test-info">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–µ:</h3>
            <div class="status info">
                <strong>–¢–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω:</strong> <span id="current-domain"></span>
            </div>
            <div class="status info">
                <strong>API URL:</strong> <code>https://knowledge.slovo-soft.ru/api/v1/mentorium</code>
            </div>
            <div class="status info">
                <strong>–ü—Ä–æ–∫—Å–∏ URL:</strong> <span id="proxy-url"></span>
            </div>
            <div class="status info">
                <strong>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–∫—Å–∏:</strong> <span id="uses-proxy"></span>
            </div>
        </div>
        
        <div class="test-info">
            <h3>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</h3>
            <button onclick="testProxyLogic()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–∫—Å–∏</button>
            <button onclick="testNetlifyFunction()">üåê –¢–µ—Å—Ç Netlify —Ñ—É–Ω–∫—Ü–∏–∏</button>
            <button onclick="testDirectAPI()">üîó –¢–µ—Å—Ç –ø—Ä—è–º–æ–≥–æ API</button>
            <button onclick="clearLogs()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
        
        <div id="test-results"></div>
        
        <div class="console-log" id="console-output">
            <div style="color: #87ceeb;">–ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...</div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ -->
    <script 
        src="./diogen-chat-widget.js"
        data-diogen-api-url="https://knowledge.slovo-soft.ru/api/v1/mentorium"
        data-diogen-project="pfki"
        data-diogen-project-id="000"
        data-diogen-user-id="test-user"
        data-diogen-basic-login="pfki"
        data-diogen-basic-password="pfki"
        data-diogen-title="Test Assistant"
        data-diogen-theme="dark">
    </script>

    <script>
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.log –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        const originalLog = console.log;
        const consoleOutput = document.getElementById('console-output');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '5px';
            logEntry.style.borderLeft = '3px solid #4caf50';
            logEntry.style.paddingLeft = '10px';
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${args.join(' ')}`;
            
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ—Å—Ç–µ
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('current-domain').textContent = window.location.origin;
            
            // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞
            setTimeout(() => {
                if (window.diogenWidget) {
                    const usesProxy = window.diogenWidget.shouldUseProxy();
                    const proxyUrl = usesProxy ? window.diogenWidget.generateProxyUrl() : '–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
                    
                    document.getElementById('uses-proxy').textContent = usesProxy ? '–î–∞' : '–ù–µ—Ç';
                    document.getElementById('proxy-url').textContent = proxyUrl;
                }
            }, 1000);
        });
        
        function addTestResult(title, status, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${status}`;
            resultDiv.innerHTML = `<strong>${title}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        function testProxyLogic() {
            console.log('üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–∫—Å–∏...');
            
            if (!window.diogenWidget) {
                addTestResult('–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–∫—Å–∏', 'error', '–í–∏–¥–∂–µ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            const widget = window.diogenWidget;
            const currentOrigin = window.location.origin;
            const apiUrl = 'https://knowledge.slovo-soft.ru/api/v1/mentorium';
            const apiOrigin = new URL(apiUrl).origin;
            
            console.log('–¢–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω:', currentOrigin);
            console.log('API –¥–æ–º–µ–Ω:', apiOrigin);
            console.log('–†–∞–∑–Ω—ã–µ –¥–æ–º–µ–Ω—ã:', apiOrigin !== currentOrigin);
            
            const shouldUseProxy = widget.shouldUseProxy();
            const proxyUrl = shouldUseProxy ? widget.generateProxyUrl() : null;
            const finalUrl = widget.getApiUrl();
            
            console.log('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–∫—Å–∏:', shouldUseProxy);
            console.log('–ü—Ä–æ–∫—Å–∏ URL:', proxyUrl);
            console.log('–§–∏–Ω–∞–ª—å–Ω—ã–π URL:', finalUrl);
            
            addTestResult('–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–∫—Å–∏', 'success', `–ü—Ä–æ–∫—Å–∏: ${shouldUseProxy ? '–î–∞' : '–ù–µ—Ç'}, URL: ${finalUrl}`);
        }
        
        async function testNetlifyFunction() {
            console.log('üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Netlify —Ñ—É–Ω–∫—Ü–∏–∏...');
            
            try {
                const response = await fetch('/api/proxy', {
                    method: 'OPTIONS'
                });
                
                console.log('OPTIONS –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å:', response.status);
                console.log('CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏:', response.headers.get('Access-Control-Allow-Origin'));
                
                if (response.ok) {
                    addTestResult('Netlify —Ñ—É–Ω–∫—Ü–∏—è', 'success', 'OPTIONS –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω');
                } else {
                    addTestResult('Netlify —Ñ—É–Ω–∫—Ü–∏—è', 'error', `OPTIONS –∑–∞–ø—Ä–æ—Å –Ω–µ—É–¥–∞—á–µ–Ω: ${response.status}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Netlify —Ñ—É–Ω–∫—Ü–∏–∏:', error);
                addTestResult('Netlify —Ñ—É–Ω–∫—Ü–∏—è', 'error', error.message);
            }
        }
        
        async function testDirectAPI() {
            console.log('üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º–æ–≥–æ API...');
            
            try {
                const response = await fetch('https://knowledge.slovo-soft.ru/api/v1/mentorium', {
                    method: 'OPTIONS'
                });
                
                console.log('–ü—Ä—è–º–æ–π API OPTIONS —Å—Ç–∞—Ç—É—Å:', response.status);
                console.log('CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏:', response.headers.get('Access-Control-Allow-Origin'));
                
                if (response.ok) {
                    addTestResult('–ü—Ä—è–º–æ–π API', 'success', 'CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
                } else {
                    addTestResult('–ü—Ä—è–º–æ–π API', 'error', `CORS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω: ${response.status}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ–≥–æ API:', error);
                addTestResult('–ü—Ä—è–º–æ–π API', 'error', 'CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å - –Ω—É–∂–µ–Ω –ø—Ä–æ–∫—Å–∏');
            }
        }
        
        function clearLogs() {
            document.getElementById('console-output').innerHTML = '<div style="color: #87ceeb;">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã...</div>';
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html> 